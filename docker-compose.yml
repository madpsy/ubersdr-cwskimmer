version: '3'

services:
    cwskimmer:
        build: .
        image: madpsy/ubersdr-cwskimmer:latest
        container_name: cwskimmer
        privileged: true
        init: true  # Enable tini init to reap zombie processes from background watchers
        
        environment:
            # Station Configuration
            - CALLSIGN=${CALLSIGN:-MM3NDH}
            - NAME=${NAME:-Nathan}
            - QTH=${QTH:-Dalgety Bay}
            - SQUARE=${SQUARE:-IO86ha}

            # UberSDR Configuration
            - UBERSDR_HOST=${UBERSDR_HOST:-ka9q_ubersdr}
            - UBERSDR_PORT=${UBERSDR_PORT:-8080}

            # Frequency Calibration
            - FREQ_CALIBRATION=${FREQ_CALIBRATION:-1}

            # Service Control
            - CWSKIMM_ENABLED=${CWSKIMM_ENABLED:-true}

            # Band Selection for 192 kHz Mode
            - BAND_160M=${BAND_160M:-false}
            - BAND_80M=${BAND_80M:-true}
            - BAND_60M=${BAND_60M:-true}
            - BAND_40M=${BAND_40M:-true}
            - BAND_30M=${BAND_30M:-true}
            - BAND_20M=${BAND_20M:-true}
            - BAND_17M=${BAND_17M:-true}
            - BAND_15M=${BAND_15M:-true}
            - BAND_12M=${BAND_12M:-true}
            - BAND_10M=${BAND_10M:-true}
        
        # Join the ka9q_ubersdr network for direct container communication
        networks:
            - sdr-network

        healthcheck:
            test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/7300' || exit 1"]
            interval: 30s
            timeout: 10s
            start_period: 60s
            retries: 3

        ports:
            - "7373:7373"  # noVNC web interface
            - "7300:7300"  # SkimSrv instance 1 telnet server
            - "7301:7301"  # SkimSrv instance 2 telnet server
            - "7550:7550"  # RBN Aggregator
        volumes:
            # Shared volume for restart trigger
            - restart-trigger:/var/run/restart-trigger


        restart: unless-stopped

# Join the external sdr-network created by ka9q_ubersdr stack
networks:
    sdr-network:
        external: true
        name: ubersdr_sdr-network

# Named volumes for persistent storage
volumes:
    restart-trigger:
        driver: local
