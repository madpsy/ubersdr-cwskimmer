version: '3'

services:
    cwskimmer:
        build: .
        image: madpsy/ubersdr-cwskimmer:latest
        container_name: cwskimmer
        privileged: true
        init: true  # Enable tini init to reap zombie processes from background watchers
        
        environment:
            # Station Configuration
            - CALLSIGN=${CALLSIGN:-MM3NDH}
            - NAME=${NAME:-Nathan}
            - QTH=${QTH:-Dalgety Bay}
            - SQUARE=${SQUARE:-IO86ha}
            
            # UberSDR Configuration
            - UBERSDR_HOST=${UBERSDR_HOST:-ka9q_ubersdr}
            - UBERSDR_PORT=${UBERSDR_PORT:-8080}
            
            # Service Control
            - CWSKIMM_ENABLED=${CWSKIMM_ENABLED:-true}
        
        healthcheck:
            test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/7300' || exit 1"]
            interval: 30s
            timeout: 10s
            start_period: 60s
            retries: 3
        
        ports:
            - "7373:7373"  # noVNC web interface
            - "7300:7300"  # SkimSrv telnet server
            - "7550:7550"  # RBN Aggregator
        volumes:
            # Bind mount for INI files - preserves configuration across restarts
            - ./data/SkimSrv.ini:/root/.wine/drive_c/users/root/AppData/Roaming/Afreet/Products/SkimSrv/SkimSrv.ini
            - ./data/UberSDRIntf.ini:/skimmersrv_1.6/app/UberSDRIntf.ini
            # Shared volume for restart trigger
            - restart-trigger:/var/run/restart-trigger
        
        
        restart: unless-stopped

# Named volumes for persistent storage
volumes:
    restart-trigger:
        driver: local
